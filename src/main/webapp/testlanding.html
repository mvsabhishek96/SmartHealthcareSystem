<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Healthcare Monitor</title>
  <link href="https://cdn.jsdelivr.net/npm/charts.css/dist/charts.min.css" rel="stylesheet">
  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --success-color: #27ae60;
      --danger-color: #e74c3c;
      --text-dark: #2d3436;
      --text-light: #f5f6fa;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      background-color: #f5f6fa;
      color: var(--text-dark);
    }
    .navbar {
      background-color: var(--primary-color);
      padding: 1rem 2rem;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .nav-links a {
      color: white;
      text-decoration: none;
      margin-left: 2rem;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .nav-links a:hover {
      background-color: var(--secondary-color);
      transform: translateY(-2px);
    }
    .container {
      max-width: 1400px;
      margin: 2rem auto;
      padding: 0 1rem;
    }
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 2rem;
      margin-top: 1.5rem;
    }
    .card {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      transition: transform 0.3s;
    }
    .card:hover {
      transform: translateY(-5px);
    }
    .chart-container {
      height: 300px;
      margin: 1rem 0;
    }
    .live-feed {
      background: var(--primary-color);
      color: white;
      padding: 1rem;
      border-radius: 8px;
      max-height: 400px;
      overflow-y: auto;
    }
    .feed-item {
      padding: 0.5rem;
      margin: 0.5rem 0;
      background: rgba(255,255,255,0.1);
      border-radius: 4px;
      animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .node-status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
    }
    .node-card {
      background: linear-gradient(135deg, var(--primary-color), #34495e);
      color: white;
      padding: 1rem;
      border-radius: 8px;
      position: relative;
    }
    .health-metric {
      height: 6px;
      background: rgba(255,255,255,0.2);
      border-radius: 3px;
      margin: 0.5rem 0;
    }
    .health-fill {
      height: 100%;
      border-radius: 3px;
      background: var(--success-color);
      transition: width 0.5s ease-out;
    }
    .blockchain-visual {
      display: flex;
      overflow-x: auto;
      padding: 1rem 0;
      gap: 1rem;
    }
    .block {
      min-width: 200px;
      background: white;
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .block:hover {
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    button {
      margin-top: 0.5rem;
      padding: 0.5rem 1rem;
      background-color: var(--secondary-color);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: opacity 0.3s;
    }
    button:hover {
      opacity: 0.9;
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <h1>Smart Healthcare Monitor</h1>
    <div class="nav-links">
      <a href="#dashboard"><ion-icon name="speedometer"></ion-icon>Dashboard</a>
      <a href="#nodes"><ion-icon name="server"></ion-icon>Nodes</a>
      <a href="#blockchain"><ion-icon name="link"></ion-icon>Blockchain</a>
      <a href="#activity"><ion-icon name="pulse"></ion-icon>Activity</a>
    </div>
  </nav>

  <div class="container">
    <!-- Real-time Dashboard Section -->
    <section id="dashboard" class="card">
      <h2>Real-time System Overview</h2>
      <div class="dashboard-grid">
        <!-- Patient Vital Signs Card -->
        <div class="card">
          <h3>Patient Vital Signs</h3>
          <div class="chart-container">
            <canvas id="vitalsChart"></canvas>
          </div>
          <button id="refreshVitals">Refresh Vitals</button>
        </div>
        <!-- Network Health Card -->
        <div class="card">
          <h3>Network Health</h3>
          <div class="node-status-grid" id="node-health">
            <!-- Dynamic node health cards -->
          </div>
          <button id="refreshNodes">Refresh Node Health</button>
        </div>
        <!-- Blockchain Status Card -->
        <div class="card">
          <h3>Blockchain Status</h3>
          <div id="blockchain-status">
            <p>Latest Hash: <code id="latest-hash">Loading...</code></p>
            <p>Total Blocks: <span id="block-count">0</span></p>
          </div>
          <div class="blockchain-visual" id="blockchain-visual">
            <!-- Blockchain blocks visualization -->
          </div>
          <button id="refreshBlockchain">Refresh Blockchain</button>
        </div>
      </div>
    </section>

    <!-- Node Status Section -->
    <section id="nodes" class="card" style="display: none;">
      <h2>Delegator Node Network</h2>
      <div class="node-status-grid" id="node-status">
        <!-- Detailed node status cards -->
      </div>
      <button id="refreshNodeStatus">Reload Detailed Node Status</button>
    </section>

    <!-- Blockchain Explorer Section -->
    <section id="blockchain" class="card" style="display: none;">
      <h2>Blockchain Explorer</h2>
      <div class="blockchain-visual" id="blockchain-blocks">
        <!-- Blockchain blocks -->
      </div>
      <table class="data-table" id="blockchain-records">
        <!-- Blockchain records table -->
      </table>
      <button id="refreshBlockchainRecords">Refresh Blockchain Records</button>
    </section>

    <!-- Activity Feed Section -->
    <section id="activity" class="card" style="display: none;">
      <h2>Real-time Activity Feed</h2>
      <div class="live-feed" id="activity-feed">
        <!-- Live activity items -->
      </div>
      <button id="refreshActivity">Refresh Activity Feed</button>
    </section>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
  <script>
    // Initialize the vital signs chart
    const ctx = document.getElementById('vitalsChart').getContext('2d');
    const vitalsChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'Heart Rate (bpm)',
          data: [],
          borderColor: '#e74c3c',
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false
      }
    });

    // Refresh button event listeners
    document.getElementById('refreshVitals').addEventListener('click', loadDashboardData);
    document.getElementById('refreshNodes').addEventListener('click', loadDashboardData);
    document.getElementById('refreshBlockchain').addEventListener('click', loadDashboardData);
    document.getElementById('refreshNodeStatus').addEventListener('click', loadNodeStatus);
    document.getElementById('refreshBlockchainRecords').addEventListener('click', loadBlockchainRecords);
    document.getElementById('refreshActivity').addEventListener('click', loadDashboardData);

    // WebSocket connection (ensure a matching server endpoint is available)
    const ws = new WebSocket('ws://localhost:8080/SmartHealthcareSystemnew/ws');
    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      const activityFeed = document.getElementById('activity-feed');
      const feedItem = document.createElement('div');
      feedItem.className = 'feed-item';
      feedItem.textContent = `${new Date().toLocaleTimeString()}: ${data.message}`;
      activityFeed.prepend(feedItem);
      switch(data.type) {
        case 'NODE_UPDATE':
          updateNodeStatus(data.payload);
          break;
        case 'BLOCKCHAIN_UPDATE':
          updateBlockchainVisualization(data.payload);
          break;
        case 'VITAL_UPDATE':
          updateVitalsChart(data.payload);
          break;
      }
    };

    // Update functions for dynamic content
    function updateNodeStatus(nodes) {
      const nodeHealthGrid = document.getElementById('node-health');
      nodeHealthGrid.innerHTML = nodes.map(node => `
        <div class="node-card">
          <h4>${node.nodeName}</h4>
          <div class="health-metric">
            <div class="health-fill" style="width: ${node.trust * 100}%"></div>
          </div>
          <small>Trust: ${Math.round(node.trust * 100)}%</small>
        </div>
      `).join('');
    }

    function updateBlockchainVisualization(blocks) {
      const blockchainVisual = document.getElementById('blockchain-visual');
      blockchainVisual.innerHTML = blocks.map(block => `
        <div class="block">
          <small>${block.timestamp}</small>
          <code>${block.dataHash.substring(0, 16)}...</code>
          <p>User: ${block.userId}</p>
        </div>
      `).join('');
    }

    function updateVitalsChart(data) {
      vitalsChart.data.labels.push(new Date().toLocaleTimeString());
      vitalsChart.data.datasets[0].data.push(data.heartRate);
      if(vitalsChart.data.labels.length > 15) {
        vitalsChart.data.labels.shift();
        vitalsChart.data.datasets[0].data.shift();
      }
      vitalsChart.update();
    }

    // Navigation: show/hide sections on nav-link click
    document.querySelectorAll('.nav-links a').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const sectionId = link.getAttribute('href');
        document.querySelectorAll('section').forEach(section => section.style.display = 'none');
        document.querySelector(sectionId).style.display = 'block';
        if (sectionId === "#nodes") loadNodeStatus();
        if (sectionId === "#blockchain") loadBlockchainRecords();
      });
    });

    // Show the dashboard section by default on page load
    document.querySelector('#dashboard').style.display = 'block';

    // Periodically refresh dashboard data
    setInterval(loadDashboardData, 3000);

    // Generic fetch function
    async function fetchData(endpoint) {
      try {
        const response = await fetch(endpoint);
        return await response.json();
      } catch (error) {
        console.error('Error fetching data from ' + endpoint + ':', error);
      }
    }

    // Load dashboard data: health data, blockchain status, and node health
    async function loadDashboardData() {
      try {
        const baseUrl = window.location.origin + '/SmartHealthcareSystemnew';
        const [healthData, blockchainStatus, nodes] = await Promise.all([
          fetchData(baseUrl + '/EdgeNodeServletdatarequest'),
          fetchData(baseUrl + '/BlockchainStatus'),
          fetchData(baseUrl + '/rhso-status')
        ]);
        updateVitalsChart(healthData);
        if (blockchainStatus) {
          document.getElementById('latest-hash').textContent = blockchainStatus.latestHash;
          document.getElementById('block-count').textContent = blockchainStatus.blockCount;
        }
        updateNodeStatus(nodes);
      } catch (error) {
        console.error('Dashboard update error:', error);
      }
    }

    // Load detailed node status data
    async function loadNodeStatus() {
      try {
        const baseUrl = window.location.origin + '/SmartHealthcareSystemnew';
        const nodeStatusData = await fetchData(baseUrl + '/node-status');
        const nodeStatusBody = document.getElementById('node-status');
        nodeStatusBody.innerHTML = '';
        if (nodeStatusData && Array.isArray(nodeStatusData)) {
          nodeStatusData.forEach(node => {
            nodeStatusBody.innerHTML += `
              <tr>
                <td>${node.nodeName}</td>
                <td>Online</td>
                <td>${node.trust}</td>
                <td>${node.fitness}</td>
              </tr>
            `;
          });
        } else {
          nodeStatusBody.innerHTML = `<tr><td colspan="4">No node data available</td></tr>`;
        }
      } catch (error) {
        console.error('Error loading node status:', error);
      }
    }

    // Load blockchain records
    async function loadBlockchainRecords() {
      try {
        const baseUrl = window.location.origin + '/SmartHealthcareSystemnew';
        const blockchainRecords = await fetchData(baseUrl + '/BlockchainRecords');
        const recordsBody = document.getElementById('blockchain-records');
        recordsBody.innerHTML = '';
        if (blockchainRecords && Array.isArray(blockchainRecords)) {
          blockchainRecords.forEach(record => {
            recordsBody.innerHTML += `
              <tr>
                <td>${record.timestamp}</td>
                <td>${record.userId}</td>
                <td>${record.dataHash}</td>
              </tr>
            `;
          });
        } else {
          recordsBody.innerHTML = `<tr><td colspan="3">No records available</td></tr>`;
        }
      } catch (error) {
        console.error('Error loading blockchain records:', error);
      }
    }

    // Initial load of dashboard data
    loadDashboardData();
  </script>
</body>
</html>
